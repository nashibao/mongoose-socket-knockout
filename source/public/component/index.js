// Generated by CoffeeScript 1.6.3
var $, ApplicationViewModel, Model, RestAdapter, SocketAdapter, app, message_schema, mgsc, oa, oo, socket,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  _this = this;

oo = ko.observable;

oa = ko.observableArray;

$ = require('jquery');

mgsc = require('./mongoose-socket-client');

Model = mgsc.Model;

SocketAdapter = mgsc.adapter.socket;

RestAdapter = mgsc.adapter.rest;

socket = SocketAdapter.create_socket('test', io);

message_schema = require('./message/model').message_schema;

ApplicationViewModel = (function() {
  function ApplicationViewModel() {
    this.remove = __bind(this.remove, this);
    this.update = __bind(this.update, this);
    this.create = __bind(this.create, this);
    this.view_page = __bind(this.view_page, this);
    var adapter;
    adapter = new SocketAdapter({
      socket: socket
    });
    this.messages_model = new Model({
      name_space: 'test',
      collection_name: 'message',
      model: message_schema,
      adapter: adapter
    });
    this.messages = this.messages_model.find({});
    this.msg = this.messages_model.findOne({});
    this.count = this.messages_model.count({});
    this.calculated = this.messages_model.aggregate({
      array: [
        {
          $group: {
            _id: 'sum',
            count: {
              $sum: 1
            },
            number_sum: {
              $sum: '$number'
            }
          }
        }
      ]
    });
    this.content = oo("");
  }

  ApplicationViewModel.prototype.view_page = function(page) {
    this.messages.query.page = page;
    return this.messages.update();
  };

  ApplicationViewModel.prototype.create = function() {
    var bl, rnd;
    rnd = Math.floor(Math.random() * 10);
    bl = this.messages_model.create({
      doc: {
        'content': this.content(),
        'number': rnd
      }
    });
    if (bl) {
      return this.content("");
    }
  };

  ApplicationViewModel.prototype.update = function(doc) {
    return this.messages_model.update({
      conditions: {
        '_id': doc._id
      },
      update: doc
    });
  };

  ApplicationViewModel.prototype.remove = function(doc) {
    return this.messages_model.remove({
      conditions: {
        '_id': doc._id
      }
    });
  };

  return ApplicationViewModel;

})();

app = app || {};

app.vm = new ApplicationViewModel;

$(document).ready(function() {
  return ko.applyBindings(app.vm);
});

module.exports = app;
